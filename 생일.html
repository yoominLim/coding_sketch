<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¡°ë‚˜ë‹¨ì–¸ë‹ˆ ìƒì¼ì¶”ì¹´ ì¼€ì´í¬</title>

  <!-- ì˜ˆìœ í°íŠ¸ (ìŠ¤í¬ë¦½íŠ¸ + í•œê¸€í°íŠ¸) -->
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Noto+Sans+KR:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:16px;
      background:
        radial-gradient(circle at 10% 10%, #ffe0fb 0, transparent 55%),
        radial-gradient(circle at 90% 20%, #ffd8e2 0, transparent 55%),
        linear-gradient(180deg,#fff0f6,#ffe8f2,#ffeef9);
      font-family:'Noto Sans KR', system-ui, -apple-system, sans-serif;
      color:#444;
    }

    .card{
      width:min(420px, 100%);
      padding:18px 18px 20px;
      border-radius:20px;
      background:rgba(255,255,255,0.9);
      box-shadow:0 18px 40px rgba(255,120,170,0.45);
      text-align:center;
      position:relative;
      overflow:hidden;
    }

    .confetti{
      position:absolute;
      inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(circle, #ff8fab 2px, transparent 0),
        radial-gradient(circle, #74c0fc 2px, transparent 0),
        radial-gradient(circle, #ffd43b 2px, transparent 0),
        radial-gradient(circle, #b197fc 2px, transparent 0);
      background-size: 26px 26px, 30px 30px, 34px 34px, 40px 40px;
      background-position: 0 0, 10px 18px, 20px 6px, 14px 26px;
      opacity:0.16;
    }

    h1{
      margin:6px 0 2px;
      font-size:26px;
      color:#ff4d9f;
      font-weight:700;
      letter-spacing:-0.5px;
    }

    .script{
      font-family:'Pacifico', cursive;
      font-size:24px;
      margin-bottom:12px;
      color:#ff5ca8;
      text-shadow:0 2px 4px rgba(255,0,120,0.25);
    }

    .sub{
      font-size:13px;
      opacity:.8;
      margin-bottom:10px;
    }

    /* ë¬´ëŒ€ / ì¼€ì´í¬ ì˜ì—­ */
    .stage{
      position:relative;
      height:260px;
      border-radius:18px;
      background:
        radial-gradient(circle at 50% 20%, rgba(255,255,255,0.9) 0, transparent 55%),
        linear-gradient(180deg,#3a0f5c,#160b32);
      margin-bottom:14px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      overflow:hidden;
    }

    /* ì ‘ì‹œ */
    .plate{
      position:absolute;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      width:290px;
      height:32px;
      background:linear-gradient(180deg,#f8f9fa,#dee2e6);
      border-radius:999px;
      box-shadow:0 16px 30px rgba(0,0,0,0.45);
    }
    .plate::after{
      content:"";
      position:absolute;
      inset:6px 20px;
      border-radius:999px;
      background:rgba(0,0,0,0.06);
    }

    /* ì¼€ì´í¬ ë³¸ì²´ */
    .cake{
      position:absolute;
      left:50%;
      bottom:34px;
      transform:translateX(-50%);
      width:220px;
      height:120px;
      border-radius:20px 20px 26px 26px;
      background:linear-gradient(180deg,#ffd6a5,#ffc8dd);
      box-shadow:0 14px 24px rgba(0,0,0,0.35);
      border:1px solid rgba(255,255,255,0.16);
    }

    /* ìœ„ìª½ í¬ë¦¼ */
    .icing{
      position:absolute;
      left:50%;
      top:-18px;
      transform:translateX(-50%);
      width:230px;
      height:45px;
      border-radius:20px;
      background:linear-gradient(180deg,#fff,#f1f3f5);
      box-shadow:inset 0 -6px 0 rgba(0,0,0,0.06);
    }
    .drip{
      position:absolute;
      top:22px;
      width:20px;
      height:26px;
      background:#f1f3f5;
      border-radius:0 0 12px 12px;
      box-shadow:inset 0 -6px 0 rgba(0,0,0,0.05);
    }
    .drip:nth-child(1){ left:18px; height:30px; }
    .drip:nth-child(2){ left:56px; height:38px; width:16px;}
    .drip:nth-child(3){ left:94px; height:26px; width:24px;}
    .drip:nth-child(4){ left:136px;height:36px;width:18px;}
    .drip:nth-child(5){ left:176px;height:32px;width:20px;}

    .sprinkles{
      position:absolute;
      left:50%;
      top:10px;
      transform:translateX(-50%);
      width:200px;
      height:28px;
      background:
        radial-gradient(circle at 10% 40%, #ff006e 2px, transparent 3px),
        radial-gradient(circle at 28% 60%, #3a86ff 2px, transparent 3px),
        radial-gradient(circle at 46% 30%, #ffbe0b 2px, transparent 3px),
        radial-gradient(circle at 64% 62%, #06d6a0 2px, transparent 3px),
        radial-gradient(circle at 82% 40%, #8338ec 2px, transparent 3px);
      opacity:0.9;
      filter:drop-shadow(0 2px 0 rgba(0,0,0,0.05));
    }

    /* ìˆ«ì ì´›ë¶ˆ (24) */
    .number-candles{
      position:absolute;
      left:50%;
      top:-54px;
      transform:translateX(-50%);
      display:flex;
      gap:10px;
      align-items:flex-end;
    }

    .num{
      position:relative;
      font-size:54px;
      font-weight:800;
      padding:0 6px;
      color:#ff4d6d;
      text-shadow:0 3px 4px rgba(0,0,0,0.35);
    }

    .num:nth-child(2){
      color:#ff8787;
    }

    .wick{
      position:absolute;
      top:-22px;
      left:50%;
      transform:translateX(-50%);
      width:4px;
      height:16px;
      background:#222;
      border-radius:4px;
    }

    .flame{
      position:absolute;
      top:-44px;
      left:50%;
      transform:translateX(-50%);
      width:18px;
      height:30px;
      border-radius:50% 50% 50% 50%;
      background:radial-gradient(circle at 50% 30%, #fff4c2 0, #ffd43b 45%, #ff6b6b 100%);
      filter:drop-shadow(0 0 12px rgba(255,180,80,0.9));
      animation:flicker 0.14s infinite alternate;
      transform-origin:50% 90%;
    }

    .flame::after{
      content:"";
      position:absolute;
      inset:5px 5px 8px;
      border-radius:50%;
      background:radial-gradient(circle at 50% 20%, #ffffff 0, #ffe066 55%, transparent 100%);
      opacity:0.85;
    }

    @keyframes flicker{
      from{ transform:translateX(-50%) rotate(-4deg) scale(0.98); }
      to  { transform:translateX(-50%) rotate(3deg) scale(1.03); }
    }

    .smoke{
      position:absolute;
      top:-40px;
      left:50%;
      transform:translateX(-50%);
      width:12px;
      height:12px;
      border-radius:50%;
      background:rgba(220,220,220,0.7);
      opacity:0;
      filter:blur(1px);
      pointer-events:none;
    }

    .num.out .flame{
      opacity:0;
      animation:none;
      transform:translateX(-50%) scale(0.4);
    }
    .num.out .smoke{
      animation:smokeUp 1.2s ease forwards;
    }

    @keyframes smokeUp{
      0%{ opacity:0; transform:translateX(-50%) translateY(12px) scale(0.4); }
      25%{ opacity:0.6; }
      100%{ opacity:0; transform:translateX(-50%) translateY(-32px) scale(2.1); }
    }

    .meter{
      margin-top:6px;
      width:100%;
      height:12px;
      border-radius:999px;
      background:#ffe3f1;
      overflow:hidden;
    }

    .bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#51cf66,#ffd43b,#ff6b6b);
      transition:width 80ms linear;
    }

    .status{
      margin-top:6px;
      font-size:12px;
      opacity:.8;
    }

    .controls{
      margin-top:10px;
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
    }

    button{
      border:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:13px;
      font-weight:600;
      background:#ff8ec0;
      color:white;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(255,0,100,0.35);
    }

    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    .msg{
      margin-top:10px;
      font-size:16px;
      font-weight:700;
      color:#ff4d9f;
      opacity:0;
      transform:translateY(6px);
      transition:.35s ease;
    }
    .msg.show{
      opacity:1;
      transform:translateY(0);
    }

    .tip{
      margin-top:4px;
      font-size:11px;
      opacity:.65;
    }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(255,255,255,0.7);
      margin:0 2px;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="confetti"></div>

    <div class="script">Happy Birthday</div>
    <h1>ì¡°ë‚˜ë‹¨ì–¸ë‹ˆ ìƒì¼ì¶”ì¹´ğŸ’›</h1>
    <div class="sub">
      <span class="pill">ë§ˆì´í¬ í—ˆìš©</span> â†’ ì¼€ì´í¬ë¥¼ í–¥í•´ <span class="pill">â€œí›„~~â€</span> ë¶ˆë©´<br>
      24 ìˆ«ì ì´›ë¶ˆì´ í•œ ë²ˆì— êº¼ì ¸ìš”!
    </div>

    <div class="stage">
      <!-- ì ‘ì‹œ -->
      <div class="plate"></div>

      <!-- ì¼€ì´í¬ ëª¸í†µ -->
      <div class="cake">
        <div class="icing">
          <div class="sprinkles"></div>
          <div class="drip"></div>
          <div class="drip"></div>
          <div class="drip"></div>
          <div class="drip"></div>
          <div class="drip"></div>
        </div>

        <!-- ìˆ«ì ì´›ë¶ˆ 24 -->
        <div class="number-candles" id="candles">
          <div class="num" data-lit="1">
            2
            <div class="wick"></div>
            <div class="flame"></div>
            <div class="smoke"></div>
          </div>
          <div class="num" data-lit="1">
            4
            <div class="wick"></div>
            <div class="flame"></div>
            <div class="smoke"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë§ˆì´í¬ ë ˆë²¨ í‘œì‹œ -->
    <div class="meter">
      <div class="bar" id="bar"></div>
    </div>

    <div class="status" id="status">ìƒíƒœ: ëŒ€ê¸° ì¤‘ (ë§ˆì´í¬ë¥¼ ì¼œë©´ â€˜í›„~â€™ ê°ì§€ë¥¼ ì‹œì‘í•´ìš”)</div>

    <div class="controls">
      <button id="btnStart">ğŸ™ï¸ ë§ˆì´í¬ ì¼œê¸°</button>
      <button id="btnRelight" disabled>ğŸ”¥ ì´›ë¶ˆ ë‹¤ì‹œ ì¼œê¸°</button>
      <button id="btnStop" disabled>â¹ï¸ ë§ˆì´í¬ ë„ê¸°</button>
    </div>

    <div class="msg" id="msg">ğŸ‰ ì´›ë¶ˆì´ êº¼ì¡Œì–´ìš”! ì¡°ë‚˜ë‹¨ì–¸ë‹ˆ ì†Œì› ë¹Œì–´! ğŸ‰</div>
    <div class="tip">ì£¼ë³€ì´ ë„ˆë¬´ ì‹œë„ëŸ¬ìš°ë©´ ì˜ ì•ˆ ë  ìˆ˜ ìˆì–´ì„œ, ê°€ëŠ¥í•˜ë©´ ì¡°ê¸ˆ ì¡°ìš©í•œ ê³³ì—ì„œ ì¨ ì¤˜ ğŸ˜Š</div>
  </div>

  <script>
    let audioCtx, analyser, micStream, sourceNode, rafId;
    let isRunning = false;
    let blown = false;

    const THRESHOLD = 0.22;
    const HOLD_MS = 220;

    const nums = document.querySelectorAll('.num');
    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const msgEl = document.getElementById('msg');

    const btnStart = document.getElementById('btnStart');
    const btnRelight = document.getElementById('btnRelight');
    const btnStop = document.getElementById('btnStop');

    let aboveSince = null;

    function setStatus(t){
      statusEl.textContent = "ìƒíƒœ: " + t;
    }

    function blowOut(){
      blown = true;
      nums.forEach(n=>{
        n.classList.add('out');
        n.dataset.lit = "0";
      });
      msgEl.classList.add('show');
      btnRelight.disabled = false;
    }

    function relight(){
      blown = false;
      nums.forEach(n=>{
        n.classList.remove('out');
        n.dataset.lit = "1";
        const smoke = n.querySelector('.smoke');
        smoke.style.animation = 'none';
        void smoke.offsetWidth;
        smoke.style.animation = '';
      });
      msgEl.classList.remove('show');
      bar.style.width = "0%";
      btnRelight.disabled = true;
      setStatus(isRunning ? "ì´›ë¶ˆ ì¼œì§! ì¼€ì´í¬ë¥¼ í–¥í•´ â€˜í›„~â€™ ë¶ˆì–´ë³´ì„¸ìš”" : "ì´›ë¶ˆ ì¼œì§! ë§ˆì´í¬ë¥¼ ì¼œë©´ â€˜í›„~â€™ ê°ì§€ë¥¼ ì‹œì‘í•´ìš”");
      aboveSince = null;
    }

    btnRelight.addEventListener('click', relight);

    function computeRMS(data){
      let sum = 0;
      for(let i=0;i<data.length;i++){
        sum += data[i]*data[i];
      }
      return Math.sqrt(sum / data.length);
    }

    function loop(){
      if(!isRunning || !analyser) return;

      const buffer = new Float32Array(analyser.fftSize);
      analyser.getFloatTimeDomainData(buffer);

      const rms = computeRMS(buffer);
      let level = Math.min(1, rms * 3.2);

      bar.style.width = (level * 100).toFixed(0) + "%";

      const now = performance.now();

      if(!blown){
        if(level >= THRESHOLD){
          if(aboveSince === null) aboveSince = now;
          const held = now - aboveSince;
          if(held >= HOLD_MS){
            setStatus("í›„~ ê°ì§€! ì´›ë¶ˆì´ êº¼ì¡Œì–´ìš” ğŸ‰");
            blowOut();
          }else{
            setStatus("ì†Œë¦¬ ê°ì§€ ì¤‘â€¦ ì¡°ê¸ˆë§Œ ë” í¬ê²Œ â€˜í›„~â€™ (ë ˆë²¨: "+level.toFixed(2)+")");
          }
        }else{
          aboveSince = null;
          setStatus("ì´›ë¶ˆ ì¼œì§! ì¼€ì´í¬ë¥¼ í–¥í•´ â€˜í›„~â€™ ë¶ˆì–´ë³´ì„¸ìš” (ë ˆë²¨: "+level.toFixed(2)+")");
        }
      }

      rafId = requestAnimationFrame(loop);
    }

    async function startMic(){
      try{
        micStream = await navigator.mediaDevices.getUserMedia({audio:true});
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;

        sourceNode = audioCtx.createMediaStreamSource(micStream);
        sourceNode.connect(analyser);

        isRunning = true;
        btnStart.disabled = true;
        btnStop.disabled = false;
        btnRelight.disabled = false;
        setStatus("ë§ˆì´í¬ ì¼œì§! ì¼€ì´í¬ë¥¼ í–¥í•´ â€˜í›„~â€™ ë¶ˆì–´ë³´ì„¸ìš”");
        loop();
      }catch(e){
        console.error(e);
        setStatus("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•´ìš”. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      }
    }

    function stopMic(){
      isRunning = false;
      if(rafId) cancelAnimationFrame(rafId);
      rafId = null;

      if(micStream){
        micStream.getTracks().forEach(t=>t.stop());
        micStream = null;
      }
      if(audioCtx){
        audioCtx.close();
        audioCtx = null;
      }

      btnStart.disabled = false;
      btnStop.disabled = true;
      setStatus("ë§ˆì´í¬ êº¼ì§. (ì¼€ì´í¬ëŠ” í™”ë©´ì— ê·¸ëŒ€ë¡œ ìˆì–´ìš”)");
    }

    btnStart.addEventListener('click', startMic);
    btnStop.addEventListener('click', stopMic);

    // ì²˜ìŒ ìƒíƒœ: ì¼€ì´í¬ëŠ” ì¼œì ¸ìˆê²Œ
    relight();
  </script>
</body>
</html>
