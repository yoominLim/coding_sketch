<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í›„~ ë¶ˆë©´ ì´›ë¶ˆ êº¼ì§ (B: ë¶ˆê½ƒ ì¶”ê°€ X)</title>

  <style>
    :root{
      /* âœ… ë¶ˆê½ƒ ìœ„ì¹˜(%) â€” ë„¤ ì‚¬ì§„ ê¸°ì¤€. í•„ìš”í•˜ë©´ ì—¬ê¸°ë§Œ ë¯¸ì„¸ì¡°ì • */
      --flame1-x: 39%;
      --flame1-y: 34%;
      --flame2-x: 63%;
      --flame2-y: 32%;

      /* âœ… â€œêº¼ì§â€ ë§ˆìŠ¤í¬ í¬ê¸°(ë¶ˆê½ƒì„ ë®ì„ ì •ë„ë¡œ) */
      --mask-size: 54px;     /* ì»¤ì§€ë©´ ë” í™•ì‹¤íˆ ê°€ë ¤ì§ */
      --mask-feather: 14px;  /* ê°€ì¥ìë¦¬ ë¶€ë“œëŸ½ê²Œ */
      --mask-color: #000;    /* ì‚¬ì§„ ë°°ê²½ì´ ê²€ì •ì´ë¼ ìì—°ìŠ¤ëŸ¬ì›€ */
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      background: radial-gradient(900px 500px at 50% 20%, rgba(255,255,255,.08), transparent 60%),
                  linear-gradient(180deg,#05060b,#0b0f1b);
      color:#fff;
      font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial;
      padding:16px;
    }

    .card{
      width:min(520px, 92vw);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }

    h1{ margin:4px 0 6px; font-size:18px; opacity:.95; }
    .sub{ margin:0 0 10px; font-size:13px; opacity:.8; line-height:1.35; }

    .stage{
      position:relative;
      border-radius:16px;
      overflow:hidden;
      background:#000;
      aspect-ratio: 1 / 1;
    }

    .cake-img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;

      /* ì‚¬ì§„ì´ ì‚´ì§ ì‚´ì•„ìˆëŠ” ëŠë‚Œ(ë¯¸ì„¸ í˜¸í¡) */
      animation: breathe 4.8s ease-in-out infinite;
      transform-origin: 50% 60%;
      filter: contrast(1.03) saturate(1.05);
    }
    @keyframes breathe{
      0%,100%{ transform: scale(1) translateY(0px); }
      50%    { transform: scale(1.01) translateY(-1.5px); }
    }

    /* íš¨ê³¼ ë ˆì´ì–´ */
    .fx{
      position:absolute;
      inset:0;
      pointer-events:none;
    }

    /* âœ… ì´›ë¶ˆ â€œêº¼ì§â€ ë§ˆìŠ¤í¬(í‰ì†Œì—” ì•ˆ ë³´ì„) */
    .mask{
      position:absolute;
      width: var(--mask-size);
      height: var(--mask-size);
      left: var(--x);
      top:  var(--y);
      transform: translate(-50%,-50%);
      border-radius:50%;
      opacity:0;
      transition: opacity .18s ease;
      z-index: 3;

      /* ê°€ì¥ìë¦¬ í¼ì§€ëŠ” ê²€ì • ì› (í‹° ì•ˆ ë‚˜ê²Œ) */
      background: radial-gradient(circle,
        var(--mask-color) 0 calc(100% - var(--mask-feather)),
        rgba(0,0,0,0) 100%
      );
    }

    /* âœ… êº¼ì§ˆ ë•Œ ë§ˆìŠ¤í¬ í‘œì‹œ */
    .out .mask{ opacity:1; }

    /* ì—°ê¸° */
    .smoke{
      position:absolute;
      width:12px;
      height:12px;
      left: var(--x);
      top:  var(--y);
      transform: translate(-50%,-50%);
      border-radius:50%;
      background: rgba(230,230,230,.8);
      filter: blur(1px);
      opacity:0;
      z-index: 4;
    }

    .out .smoke{ animation: smokeUp 1.2s ease forwards; }

    @keyframes smokeUp{
      0%  { opacity:0; transform:translate(-50%,-50%) translateY(10px) scale(.6); }
      20% { opacity:.6; }
      100%{ opacity:0; transform:translate(-50%,-50%) translateY(-40px) scale(2.2); }
    }

    /* â€œë¶ˆ êº¼ì§„ ë’¤â€ ì „ì²´ ë¶„ìœ„ê¸° ì‚´ì§ ì–´ë‘¡ê²Œ(ì„ íƒ) */
    .dim{
      position:absolute;
      inset:0;
      background: radial-gradient(600px 420px at 50% 40%, rgba(0,0,0,0.00), rgba(0,0,0,0.24));
      opacity:0;
      transition: opacity .30s ease;
      pointer-events:none;
      z-index: 2;
      mix-blend-mode:multiply;
    }
    .fx.out ~ .dim{ opacity:1; }

    /* UI */
    .meter{
      margin:10px 0 0;
      width:100%;
      height:12px;
      border-radius:999px;
      background: rgba(255,255,255,.14);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg,#51cf66,#ffd43b,#ff6b6b);
      transition: width 80ms linear;
    }
    .status{ margin-top:8px; font-size:12px; opacity:.85; min-height:18px; }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    button{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color:#fff;
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .msg{
      margin-top:10px;
      font-size:15px;
      font-weight:800;
      opacity:0;
      transform: translateY(6px);
      transition:.35s ease;
    }
    .msg.show{ opacity:1; transform: translateY(0); }
  </style>
</head>

<body>
  <div class="card">
    <h1>ğŸ‚ Bë²„ì „: ì‚¬ì§„ ë¶ˆê½ƒ ê·¸ëŒ€ë¡œ + â€œêº¼ì§â€ë§Œ ì—°ì¶œ</h1>
    <p class="sub">ì‚¬ì§„ì€ <b>cake.png</b> 1ì¥ë§Œ ì˜¬ë ¤ë‘ë©´ ë¼! â€œí›„~â€ í•˜ë©´ ë¶ˆê½ƒì´ êº¼ì§„ ê²ƒì²˜ëŸ¼ ë³´ì—¬.</p>

    <div class="stage">
      <img class="cake-img" src="cake.png" alt="birthday cake photo" />

      <div class="fx" id="fx">
        <!-- ë¶ˆê½ƒ ìë¦¬ 2ê°œ: í‰ì†Œì—” ì•ˆ ë³´ì´ë‹¤ê°€(opacity 0) í›„~ í•˜ë©´ ê²€ê²Œ ë®ìŒ -->
        <div class="mask" style="--x: var(--flame1-x); --y: var(--flame1-y);"></div>
        <div class="mask" style="--x: var(--flame2-x); --y: var(--flame2-y);"></div>

        <!-- ì—°ê¸° 2ê°œ -->
        <div class="smoke" style="--x: var(--flame1-x); --y: var(--flame1-y);"></div>
        <div class="smoke" style="--x: var(--flame2-x); --y: var(--flame2-y);"></div>
      </div>

      <div class="dim"></div>
    </div>

    <div class="meter"><div class="bar" id="bar"></div></div>
    <div class="status" id="status">ìƒíƒœ: ëŒ€ê¸° ì¤‘ (ë§ˆì´í¬ë¥¼ ì¼œë©´ â€˜í›„~â€™ ê°ì§€ë¥¼ ì‹œì‘í•´ìš”)</div>

    <div class="controls">
      <button id="btnStart">ğŸ™ï¸ ë§ˆì´í¬ ì¼œê¸°</button>
      <button id="btnRelight" disabled>ğŸ”¥ ë‹¤ì‹œ ì¼œê¸°</button>
      <button id="btnStop" disabled>â¹ï¸ ë§ˆì´í¬ ë„ê¸°</button>
    </div>

    <div class="msg" id="msg">ğŸ‰ ì´›ë¶ˆì´ êº¼ì¡Œì–´ìš”! ì†Œì› ë¹Œì–´! ğŸ‰</div>
  </div>

  <script>
    let audioCtx, analyser, micStream, sourceNode, rafId;
    let isRunning = false;
    let blown = false;

    const THRESHOLD = 0.22; // ë¯¼ê°ë„(ì‘ì„ìˆ˜ë¡ ì˜ êº¼ì§)
    const HOLD_MS = 220;    // â€˜í›„~â€™ ì§€ì† ì‹œê°„

    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const msgEl = document.getElementById('msg');
    const fx = document.getElementById('fx');

    const btnStart = document.getElementById('btnStart');
    const btnRelight = document.getElementById('btnRelight');
    const btnStop = document.getElementById('btnStop');

    let aboveSince = null;

    function setStatus(t){ statusEl.textContent = "ìƒíƒœ: " + t; }

    function computeRMS(data){
      let sum = 0;
      for(let i=0;i<data.length;i++){
        const v = data[i];
        sum += v*v;
      }
      return Math.sqrt(sum / data.length);
    }

    function blowOut(){
      blown = true;
      fx.classList.add('out');   // âœ… ë¶ˆê½ƒ ì¶”ê°€ ì—†ì´ â€œêº¼ì§â€ë§Œ ì—°ì¶œ
      msgEl.classList.add('show');
      btnRelight.disabled = false;
      setStatus("í›„~ ê°ì§€! ì´›ë¶ˆì´ êº¼ì¡Œì–´ìš” ğŸ‰");
    }

    function relight(){
      blown = false;
      fx.classList.remove('out');

      // ì—°ê¸° ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹
      fx.querySelectorAll('.smoke').forEach(s=>{
        s.style.animation='none';
        void s.offsetWidth;
        s.style.animation='';
      });

      msgEl.classList.remove('show');
      bar.style.width = "0%";
      btnRelight.disabled = true;
      aboveSince = null;

      setStatus(isRunning ? "ì´›ë¶ˆ ì¼œì§! â€˜í›„~â€™ ë¶ˆì–´ë³´ì„¸ìš”" : "ì´›ë¶ˆ ì¼œì§! ë§ˆì´í¬ë¥¼ ì¼œë©´ â€˜í›„~â€™ ê°ì§€ë¥¼ ì‹œì‘í•´ìš”");
    }

    btnRelight.addEventListener('click', relight);

    function loop(){
      if(!isRunning || !analyser) return;

      const buffer = new Float32Array(analyser.fftSize);
      analyser.getFloatTimeDomainData(buffer);

      const rms = computeRMS(buffer);
      const level = Math.min(1, rms * 3.2);
      bar.style.width = (level * 100).toFixed(0) + "%";

      const now = performance.now();

      if(!blown){
        if(level >= THRESHOLD){
          if(aboveSince === null) aboveSince = now;
          const held = now - aboveSince;

          if(held >= HOLD_MS){
            blowOut();
          }else{
            setStatus("ì†Œë¦¬ ê°ì§€ ì¤‘â€¦ ì¡°ê¸ˆë§Œ ë” í¬ê²Œ â€˜í›„~â€™ (ë ˆë²¨: " + level.toFixed(2) + ")");
          }
        }else{
          aboveSince = null;
          setStatus("ì´›ë¶ˆ ì¼œì§! â€˜í›„~â€™ ë¶ˆì–´ë³´ì„¸ìš” (ë ˆë²¨: " + level.toFixed(2) + ")");
        }
      }

      rafId = requestAnimationFrame(loop);
    }

    async function startMic(){
      try{
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;

        sourceNode = audioCtx.createMediaStreamSource(micStream);
        sourceNode.connect(analyser);

        isRunning = true;
        btnStart.disabled = true;
        btnStop.disabled = false;
        btnRelight.disabled = false;

        setStatus("ë§ˆì´í¬ ì¼œì§! â€˜í›„~â€™ ë¶ˆì–´ë³´ì„¸ìš”");
        loop();
      }catch(e){
        console.error(e);
        setStatus("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•´ìš”. Safari ì„¤ì •ì—ì„œ ë§ˆì´í¬ í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      }
    }

    function stopMic(){
      isRunning = false;
      if(rafId) cancelAnimationFrame(rafId);
      rafId = null;

      if(micStream){
        micStream.getTracks().forEach(t => t.stop());
        micStream = null;
      }
      if(audioCtx){
        audioCtx.close();
        audioCtx = null;
      }

      btnStart.disabled = false;
      btnStop.disabled = true;
      bar.style.width = "0%";
      setStatus("ë§ˆì´í¬ êº¼ì§. (í™”ë©´ì€ ê·¸ëŒ€ë¡œ)");
    }

    btnStart.addEventListener('click', startMic);
    btnStop.addEventListener('click', stopMic);

    // ì´ˆê¸°
    relight();
  </script>
</body>
</html>


